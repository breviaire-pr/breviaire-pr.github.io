<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="google-site-verification" content="QEHugPIPzX5vDvVdc4EOzFn4Q-L5lSUP60V2q6FjkBY" />
  <title>Bréviaire de Port-Royal</title>
  
  <style>
  .darkmode--activated  img {
      filter: invert(100%);
  }
  </style>
</head>


<body style="margin-bottom: 0px">
    <div id="main" style="margin: auto; text-align: center;">

      <!-- choix général du type de navigation -->
      <div style="margin-bottom: 0.6em;">
        <strong>Bréviaire de Port-Royal</strong>
        |
        <form id="gen" style="display: inline">
          <label for="afficher">Affichage</label>
          <select name="afficher" id="afficher">
            <option>Original</option>
            <option>Dynamique</option>
          </select>
          |
          <label for="afficher">Version</label>
          <select name="afficher" id="afficher">
          </select>
        </form>
      </div>
      
      <!-- Navigation page par page -->
      <div id="nav-originale">
        <form id="form-nav-originale" style="display: inline">
          <label for="parts">Partie</label>
            <select name="parts" id="parts">
            </select>
            |
            <label for="chapters">Chapitre</label>
            <select name="chapters" id="chapters">
            </select>
            |
            <button id="displayInfo"><span id="infoIcon">ℹ</span>&nbsp;info</button>
        </form>
      </div>
      
      <!-- Navigation dynamique -->
      <div id="nav-dyn"  style="display:none">
        <form id="form-nav-dyn" style="display: inline;">
          <div>
            <input id="propre" type="checkbox"></input>
            <label for="propre">Commun :</label>
              <select name="office" id="office">
                <option>Aux Matines</option>
                <option>Aux Laudes</option>
                <option>À Prime</option>
                <option>À Tierce</option>
                <option>À Sexte</option>
                <option>Aux Nones</option>
                <option>Aux Vêpres</option>
                <option>Aux Complies</option>
              </select>
              <label for="jour"> le </label>
              <select name="jour" id="jour">
                <option>dimanche</option>
                <option>lundi</option>
                <option>mardi</option>
                <option>mercredi</option>
                <option>meudi</option>
                <option>vendredi</option>
                <option>samedi</option>
              </select>
          </div>
          
          <div>
            <input id="propre-temps" type="checkbox"></input>
            <label for="propre-temps">Propre du temps :</label>
              <select name="office" id="office">
                <option>Avent</option>
                <option>Avent</option>
                <option>Avent</option>
                <option>Avent</option>
                <option>Avent</option>
                <option>Avent</option>
              </select>
              <select name="propre-temps-semaine" id="office">
                <option>1er dimanche</option>
                <option>Avent</option>
                <option>Avent</option>
                <option>Avent</option>
                <option>Avent</option>
                <option>Avent</option>
              </select>
          </div>
          
          <div>
            <input id="propre-temps" type="checkbox"></input>
            <label for="propre-temps">Propre des Saints :</label>
            <label for="propre-temps">Le</label>
              <select name="office" id="office">
                <option>5</option>
              </select>
              <select name="propre-temps-semaine" id="office">
                <option>Janvier</option>
              </select>&nbsp;&nbsp;&nbsp;
              <button id="displayInfo" style="border: none;">
                <span id="infoIcon">⏰</span>
              </button>&nbsp;&nbsp;&nbsp;
             <label for="propre-temps">Commun :</label>
              <select name="propre-temps-semaine" id="office">
                <option>d’un Saint Martyr</option>
              </select>
          </div>
        </form>
      </div>
      
      
      
      <!-- Infos sur l’édition -->
    <div id="infoWindow" style="margin-top: 0.2em; margin-bottom: 0.4em; display: none; text-align: center;" >
        <hr/>
            Page courante tirée de : <span style="font-style: italic;" id="bookInfo"></span>, <span id="editionInfo"></span>
            <a id="pdfLink" target="_blank">(pdf original)</a>
             <br/>
             <a href="https://github.com/bible-sacy/bible-sacy.github.io/issues" target="_blank">rapporter une erreur</a>
             &nbsp;|&nbsp;
             <a href="https://github.com/bible-sacy/bible-sacy.github.io" target="_blank">code source du site web</a>
             &nbsp;|&nbsp;
             <a href="https://github.com/bible-sacy/bible-sacy.github.io/blob/master/README.md#conditions-dutilisation" target="_blank">conditions d’utilisation</a>
             <br/>
             <button id="hideInfo" style="margin-top: 0.3em;"><small>❌&nbsp;cacher ces informations</small></button>
          </div>
  
  
  
  
  <!-- Pages -->
  <hr/>
  
  
  
  
  <!------------------------
    AFFICHAGE CLASSIQUE
    
    page par page
  -------------------------->
  
  <div id="page-original">
    <div>
      <button 
        id="prev-top" 
        style="width: 25%; font-weight: bold;"
      >&larr;</button>
      &nbsp;
      <form id="page-form" style="display: inline">
        <label for="pages">Page</label>&nbsp;
        <input type="number" id="pages" name="pages"/>
      </form>
      &nbsp;
      <button 
        id="next-top" 
        style="width: 25%; font-weight: bold;"
      >&rarr;</button>
    </div>
    
    <div class="image">
      <img id="page" style="max-width: 50em; width: 100%; min-width: 20em;"/>
    </div>
    
    <div>
      <button 
        id="prev-bottom" 
        style="width: 30%; font-weight: bold;"
      >&larr;</button>
      &nbsp;&nbsp;
      <button 
        id="next-bottom" 
        style="width: 30%; font-weight: bold;"
      >&rarr;</button>
    </div>
  </div>
  
  
  
  
  <!------------------------
    AFFICHAGE DYNAMIQUE
    
    au choix de l’utilisateur
  -------------------------->
  
  
  <!-- PAGE COMMUN -->
  <div id="page-commun" style="display:none;">
    <div>
      <button 
        id="prev-top-commun" 
        style="width: 25%; font-weight: bold;"
      >&larr;</button>
      &nbsp;
      <form id="page-form-commun" style="display: inline">
        <label for="pages">Page</label>&nbsp;
        <input type="number" id="pages" name="pages"/>
      </form>
      &nbsp;
      <button 
        id="next-top-commun" 
        style="width: 25%; font-weight: bold;"
      >&rarr;</button>
    </div>
    
    <div class="image">
      <img id="page-commun" style="max-width: 50em; width: 100%; min-width: 20em;"/>
    </div>
    
    <div>
      <button 
        id="prev-bottom-commun" 
        style="width: 30%; font-weight: bold;"
      >&larr;</button>
      &nbsp;&nbsp;
      <button 
        id="next-bottom-commun" 
        style="width: 30%; font-weight: bold;"
      >&rarr;</button>
    </div>
  </div>&nbsp;
  
  
  
  
  
  
  
  
  
  <!-- PAGE COMMUN DES SAINTS -->
  <div id="page-commun-saints" style="display:none;">
    <div>
      <button 
        id="prev-top-commun-saints" 
        style="width: 25%; font-weight: bold;"
      >&larr;</button>
      &nbsp;
      <form id="page-form-commun-saints" style="display: inline">
        <label for="pages">Page</label>&nbsp;
        <input type="number" id="pages" name="pages"/>
      </form>
      &nbsp;
      <button 
        id="next-top-commun-saints" 
        style="width: 25%; font-weight: bold;"
      >&rarr;</button>
    </div>
    
    <div class="image-commun-saints">
      <img id="page" style="max-width: 50em; width: 100%; min-width: 20em;"/>
    </div>
    
    <div>
      <button 
        id="prev-bottom-commun-saints" 
        style="width: 30%; font-weight: bold;"
      >&larr;</button>
      &nbsp;&nbsp;
      <button 
        id="next-bottom-commun-saints" 
        style="width: 30%; font-weight: bold;"
      >&rarr;</button>
    </div>
  </div>&nbsp;
  
  
  
  
  
  
  
  
  
  <!-- PAGE Propre du temps -->
  <div id="page-propre-temps" style="display:none;">
    <div>
      <button 
        id="prev-top-propre-temps" 
        style="width: 25%; font-weight: bold;"
      >&larr;</button>
      &nbsp;
      <form id="page-form-propre-temps" style="display: inline">
        <label for="pages">Page</label>&nbsp;
        <input type="number" id="pages" name="pages"/>
      </form>
      &nbsp;
      <button 
        id="next-top-propre-temps" 
        style="width: 25%; font-weight: bold;"
      >&rarr;</button>
    </div>
    
    <div class="image-propre-temps">
      <img id="page" style="max-width: 50em; width: 100%; min-width: 20em;"/>
    </div>
    
    <div>
      <button 
        id="prev-bottom-propre-temps" 
        style="width: 30%; font-weight: bold;"
      >&larr;</button>
      &nbsp;&nbsp;
      <button 
        id="next-bottom-propre-temps" 
        style="width: 30%; font-weight: bold;"
      >&rarr;</button>
    </div>
  </div>&nbsp;
  
  
  
  
  
  
  
  
  
  <!-- PAGE Propre des Saints -->
  <div id="page-propre-saints" style="display:none;">
    <div>
      <button 
        id="prev-top-propre-saints" 
        style="width: 25%; font-weight: bold;"
      >&larr;</button>
      &nbsp;
      <form id="page-form-propre-saints" style="display: inline">
        <label for="pages">Page</label>&nbsp;
        <input type="number" id="pages" name="pages"/>
      </form>
      &nbsp;
      <button 
        id="next-top-propre-saints" 
        style="width: 25%; font-weight: bold;"
      >&rarr;</button>
    </div>
    
    <div class="image-propre-saints">
      <img id="page" style="max-width: 50em; width: 100%; min-width: 20em;"/>
    </div>
    
    <div>
      <button 
        id="prev-bottom-propre-saints" 
        style="width: 30%; font-weight: bold;"
      >&larr;</button>
      &nbsp;&nbsp;
      <button 
        id="next-bottom-propre-saints" 
        style="width: 30%; font-weight: bold;"
      >&rarr;</button>
    </div>
  </div>&nbsp;
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
      </div>
      
        <script>
            //console.log("location.hash is", location.hash)

            const PDFS_BASE = 'pdfs'

            window.addEventListener('popstate', () => {
                if (location.hash && (m = location.hash.match(/#\/(.+)\/(.+)/))) {
                    let newBook = m[1]
                    let newPage = m[2]
                    if (newBook !== books.value) {
                        books.value = newBook
                        useBook(books.value, newPage)
                    } else if (newPage !== pageSelector.value) {
                        console.log("setPage from popState with newPage ", newPage )
                        setPage(newPage)
                    }
                }
            })

            const img = document.getElementById("page")
            const parts = document.getElementById("parts")
            const chapters = document.getElementById("chapters")
            const pageSelector = document.getElementById("pages")
            
            const pdfLink = document.getElementById("pdfLink")
            const bookInfo = document.getElementById("bookInfo")
            const editionInfo = document.getElementById("editionInfo")
            const displayInfo = document.getElementById("displayInfo")
            const infoIncon = document.getElementById("infoIcon")
            const hideInfo = document.getElementById("hideInfo")
            const infoWindow = document.getElementById("infoWindow")
            
            const nextTop = document.getElementById("next-top")
            const nextBottom = document.getElementById("next-bottom")
            const prevTop = document.getElementById("prev-top")
            const prevBottom = document.getElementById("prev-bottom")

            let infoShown = false

            const toggleInfo = (ev) => {
                ev.preventDefault()
                if (infoShown) {
                    infoIcon.innerText = 'ℹ'
                    infoWindow.style.display = 'none'
                } else {
                    infoWindow.style.display = ''
                    infoIcon.innerText = '❌'
                }
                infoShown = !infoShown
            }

            displayInfo.addEventListener("click", toggleInfo)

            hideInfo.addEventListener("click", toggleInfo)

            let folder = null
            let offset = null
            let max = null
            let min = null
            let pdf = null
            let foldersMap = null
            let bookKeysMap = {}
            let bookList = []

            document.getElementById("page-form").addEventListener("submit", e => e.preventDefault())
            document.getElementById("book-form").addEventListener("submit", e => e.preventDefault())
            
            books.addEventListener("change", e => {
                useBook(books.value, null)
            })

            fetch("index.json")
            .then(response => response.json())
            .then(index => {
                index.books.forEach(value => {
                    books.options.add(new Option(value[1], value[0]))
                    bookKeysMap[value[0]] = value[1]
                    bookList.push(value[0])
                })
                foldersMap = index.folders
                if (location.hash && (m = location.hash.match(/#\/(.+)\/(.+)/))) {
                    books.value = m[1]
                    useBook(books.value, m[2])
                } else {
                    books.value = index.default
                    useBook(index.default, null)    
                }
            })

            

            let useBook = (nameArg, page) => fetch(`jsons/${nameArg}.json`)
                .then(response => response.json())
                .then(json => {
                    //console.log("json is ", json)
                    folder = json.folder
                    pdf = foldersMap[folder][3]
                    offset = json.offset
                    max = json.max
                    min = json.min
                    pages.min = min
                    pages.max = max
                    while (chapters.options.length) chapters.remove(0);
                    json.chapters.forEach(value => {
                        chapters.options.add(new Option(value[0], value[1]))
                    })
                    bookInfo.innerText = foldersMap[folder][0]
                    editionInfo.innerText = foldersMap[folder][1] + ", " + foldersMap[folder][2]
                    pdfLink.href = `${PDFS_BASE}/${pdf}`
                    console.log("setPage from useBook")
                    setPage(page ? page : json.chapters[0][1])
                })

            let nextPage = () => {
                if (parseInt(pageSelector.value) < max) {
                    pageSelector.value = parseInt(pageSelector.value) + 1
                    document.body.scrollTop = document.documentElement.scrollTop = 0
                    console.log("update from next")
                    update()
                } else {
                    let bookIdx = bookList.indexOf(books.value)
                    if (bookIdx < bookList.length - 1) {
                        books.value = bookList[bookIdx + 1]
                        useBook(books.value, 'min')
                    }
                }
            }

            let previousPage = () => {
                if (parseInt(pageSelector.value) > min) {
                    pageSelector.value = parseInt(pageSelector.value) - 1
                    console.log("update from prev")
                    update()
                } else {
                    let bookIdx = bookList.indexOf(books.value)
                    if (bookIdx > 0) {
                        books.value = bookList[bookIdx - 1]
                        useBook(books.value, 'max')
                    }
                }
            }

            let setPage = p =>  {
                if (p === 'max') {
                    pageSelector.value = max
                    console.log("update from setPage")
                    update()
                } else if (p === 'min') {
                    pageSelector.value = min
                    console.log("update from setPage")
                    update()
                } else if (p >= min && p <= max) {
                    pageSelector.value = parseInt(p)
                    console.log("update from setPage")
                    update()
                }
            }

            let update = () => {
                console.log("update called…")
                const page = parseInt(pageSelector.value)
                const number = offset + page
                if (folder.match('/')) {
                   const [suffix, f]= folder.split('/', 2)
                   img.src = `pngs${suffix}/${f}/${f}-${number}.png`
                } else {
                    img.src = `pngs/${folder}/${folder}-${number}.png`
                }
                if (parseInt(chapters.value) !== page) {
                    chapters.value = null;
                }
                location.hash = `/${books.value}/${page}`
                if (foldersMap[folder].length > 4) {
                    let corrections = foldersMap[folder][4]
                    let correctionPages = []
                    for (let correctionPage in corrections) {
                        if (corrections[correctionPage].find(p => p == page) !== undefined) {
                            correctionPages.push(correctionPage)
                        }
                    }
                    if (correctionPages.length > 0) {
                        showErrors(correctionPages)
                    } else {
                        clearErrors()    
                    }
                } else {
                    clearErrors()
                }
                document.title = `Bible de Sacy : ${books.selectedOptions[0].innerText} p. ${page}`
            }

            let showErrors = (errorArray) => {
                console.log("ERROR DETECTED", errorArray)
                fautes.innerHTML = `Faute(s) à corriger : voir ` +
                                    errorArray.map(p => `<a href="#/${p}">${bookKeysMap[p.split('/')[0]]} page ${p.split('/')[1]}</a>`).join(", ") +
                                    "."
            }

            let clearErrors = () => {
                fautes.innerHTML = ''
            }

            pageSelector.addEventListener("change", update)

            chapters.addEventListener("change", event => {
                // console.log("event is ", event)
                setPage(chapters.value)
            })



            document.addEventListener('keydown', event => {
                // console.log("event is ", event)
                switch(event.key) {
                    case 'ArrowRight':
                        nextPage()
                        break
                    case 'ArrowLeft':
                        previousPage()
                        break
                }
            })
            
            nextTop.addEventListener("click", nextPage)
            nextBottom.addEventListener("click", nextPage)
            prevTop.addEventListener("click", previousPage)
            prevBottom.addEventListener("click", previousPage)

        </script>
        <script src="darkmode-js.min.js"></script>
        <script>
        new Darkmode({
            bottom: 'unset',
            right: 'unset',
            left: '32px',
            label: '🌓'
        }).showWidget();
        </script>
  </body>
</html>
